nextflow.enable.dsl=2
cleanup=true

includeConfig "$baseDir/modules/config/params.config"


singularity {
  enabled = true
  singularity.envWhitelist = ["SINGULARITY_TMPDIR"]
  runOptions = '--bind /orfeo:/orfeo --bind $SINGULARITY_TMPDIR:/tmp'
}
 
process {
  executor='slurm'
  queue='EPYC'
  errorStrategy = 'finish'
}

process {
  withName: 'VEP_ANNOTATE' {
    time='12h'
    container = 'https://depot.galaxyproject.org/singularity/ensembl-vep:110.1--pl5321h2a3209d_0'
    memory = '20 GB'
  }

  withName: 'VCF2MAF' {
    container = 'https://depot.galaxyproject.org/singularity/vcf2maf%3A1.6.20--0'
  }

  withName: 'MAFTOOLS' {
    memory = '5 GB'
    container = 'https://depot.galaxyproject.org/singularity/bioconductor-maftools%3A2.8.0--r41hd029910_0'
  }
}

process {
  withName: 'ANNOVAR_ANNOTATE' {
    time='12h'
    container = 'shub://IARCbioinfo/table_annovar-nf:v1.1'
    memory='10 GB'
  }

  withName: 'ANNOVAR2MAF' {
    time='24h'
    memory='5 GB'
  }
}


process {
  withName: 'SNPEFF_ANNOTATE' {
    time='24h'
    container = 'https://depot.galaxyproject.org/singularity/snpeff:5.1--hdfd78af_2'
    memory='16 GB'
  }
}

process {
  withName: 'PLATYPUS_CALL_VARIANTS' {
    time='24h'
    container = 'https://depot.galaxyproject.org/singularity/platypus-variant%3A0.8.1.1--htslib1.5_0'
  }
}

process {
   withName: 'BCFTOOLS_SPLIT_VEP' {
   container = 'https://depot.galaxyproject.org/singularity/bcftools%3A1.14--hde04aa1_1'
  }
}

process {
  withName: 'SEQUENZA_CNAqc' {
    memory = '300 GB'
    time = '3h'
    
    errorStrategy = 'finish'
    container = 'file:///orfeo/LTS/CDSLab/LT_storage/shared/containers/singularity/cdslab.sif'

    ext.args = {[
      "norm_method": params.seqcna_norm_method,
      "window": params.seqcna_window,
      "gamma": params.seqcna_gamma,
      "kmin": params.seqcna_kmin,
      "min_reads_baf": params.seqcna_min_reads_baf,
      "min_reads": params.seqcna_min_reads,
      "min_reads_normal": params.seqcna_reads_normal,
      "max_mut_types": params.seqcna_max_mut_types,

      "low_cell": params.seqcna_low_cell,
      "up_cell": params.seqcna_up_cell,
      "low_ploidy": params.seqcna_low_ploidy,
      "up_ploidy": params.seqcna_up_ploidy,
      "delta_cellularity": params.seqcna_delta_cellularity,
      "delta_ploidy": params.seqcna_delta_ploidy,

      "matching_strategy": params.seqcna_matching_strategy
      ]}
  }

  withName: 'VARTRIX' {
    memory='50 GB'
    time='2h'
    container = 'https://depot.galaxyproject.org/singularity/vartrix%3A1.1.22--h27d5293_3'
    ext.args   = {[
        "scoring": params.vartrix_scoring_method,
        "padding": params.vartrix_padding,
        "umi": params.vartrix_umi
    ]}
  }

  withName: 'RDS_PROCESSING' {
    memory='50 GB'
    time='1h'
    container = 'docker://lvaleriani/cnaqc:v5'
  }
  
  withName: 'VIBER' {
    memory='128 GB'
    time='2h'
    container='file:///fast/cdslab/ebusca00/singularity/cdslab.sif'
    // container='file:///orfeo/LTS/CDSLab/LT_storage/shared/containers/singularity/cdslab.sif'
    ext.args = {[
      "K" : params.viber_K,
      "samples" : params.viber_samples,
      "alpha_0" : params.viber_alpha_0,
      "a_0" : params.viber_a_0,
      "b_0" : params.viber_b_0,
      "maxIter" : params.viber_maxIter,
      "epsilon_conv" : params.viber_epsilon_conv,
      "q_init" : params.viber_q_init,
      "trace" : params.viber_trace,
      "binomial_cutoff" : params.viber_binomial_cutoff,
      "dimensions_cutoff" : params.viber_dimensions_cutoff,
      "pi_cutoff" : params.viber_pi_cutoff,
      "re_assign" : params.viber_re_assign,
      "mode": params.mode
    ]}
  }

  withName: 'PYCLONEVI' {
    memory='50 GB'
    time='2h'
    container = 'https://depot.galaxyproject.org/singularity/pyclone-vi%3A0.1.3--pyhca03a8a_0'
    ext.args   = { [
      "n_cluster": params.pyclonevi_n_cluster,
      "density": params.pyclonevi_density,
      "n_grid_point": params.pyclonevi_n_grid_point,
      "n_restarts": params.pyclonevi_n_restarts,
      "mode": params.mode
    ]}
  }

  withName: "MOBSTERh" {
    memory='128 GB'
    time='2h'
    container='file:///fast/cdslab/ebusca00/singularity/cdslab.sif'
    //container='file:///orfeo/LTS/CDSLab/LT_storage/shared/containers/singularity/cdslab.sif'
    ext.args = {[
      "K" : params.mobster_K,
      "samples" : params.mobster_samples,
      "init" : params.mobster_init,
      "tail" : params.mobster_tail,
      "epsilon" : params.mobster_epsilon,
      "maxIter" : params.mobster_maxIter,
      "fit_type" : params.mobster_fit_type,
      "seed" : params.mobster_seed,
      "model_selection" : params.mobster_model_selection,
      "trace" : params.mobster_trace,
      "parallel" : params.mobster_parallel,
      "pi_cutoff" : params.mobster_pi_cutoff,
      "n_cutoff" : params.mobster_n_cutoff,
      "auto_setup" : params.mobster_auto_setup,
      "silent" : params.mobster_silent
    ]}
  }

  withName: "CTREE" {
    memory='50 GB'
    time='2h'
    container='file:///fast/cdslab/ebusca00/singularity/cdslab.sif'
    ext.args = {[
      "sspace_cutoff" : params.ctree_sspace_cutoff,
      "n_sampling" : params.ctree_n_sampling,
      "store_max" : params.ctree_store_max,
      "mode": params.mode
    ]}
  }

  withName: "JOINT_FIT" {
    memory='50 GB'
    time='2h'
    container='file:///orfeo/LTS/CDSLab/LT_storage/shared/containers/singularity/cdslab.sif'
  }
}

process {
  withName: 'SIG_PROFILER' {
    time='5h'
    memory='100 GB'
    container = "docker://fauzul/sigprofiler:1.0"
    ext.args   = {[
      "reference_genome": params.sigprofiler_reference_genome,
      "exome": params.sigprofiler_exome,
      "bed_file": params.sigprofiler_bed_file,
      "chrom_based": params.sigprofiler_chrom_based,
      "plot": params.sigprofiler_plot,
      "tsb_stat": params.sigprofiler_tsb_stat,
      "seqInfo": params.sigprofiler_seqInfo,
      "cushion": params.sigprofiler_cushion,
      "volume": params.sigprofiler_volume,
      "input_type": params.sigprofiler_input_type,
      "context_type": params.sigprofiler_context_type,
      "minimum_signatures": params.sigprofiler_minimum_signatures,
      "maximum_signatures": params.sigprofiler_maximum_signatures,
      "nmf_replicates": params.sigprofiler_nmf_replicates,
      "resample": params.sigprofiler_resample,
      "seeds": params.sigprofiler_seeds,
      "matrix_normalization": params.sigprofiler_matrix_normalization,
      "nmf_init": params.sigprofiler_nmf_init,
      "min_nmf_iterations": params.sigprofiler_min_nmf_iterations,
      "max_nmf_iterations": params.sigprofiler_max_nmf_iterations,
      "nmf_test_conv": params.sigprofiler_nmf_test_conv,
      "tolerance": params.sigprofiler_tolerance,
      "cpu": params.sigprofiler_cpu,
      "gpu": params.sigprofiler_gpu,
      "batch_size": params.sigprofiler_batch_size,
      "stability": params.sigprofiler_stability,
      "min_stability": params.sigprofiler_min_stability,
      "combined_stability": params.sigprofiler_combined_stability,
      "cosmic_version": params.sigprofiler_cosmic_version,
      "de_novo_fit_penalty": params.sigprofiler_de_novo_fit_penalty,
      "nnls_add_penalty": params.sigprofiler_nnls_add_penalty,
      "nnls_remove_penalty": params.sigprofiler_nnls_remove_penalty,
      "initial_remove_penalty": params.sigprofiler_initial_remove_penalty,
      "refit_denovo_signatures": params.sigprofiler_refit_denovo_signatures,
      "make_decomposition_plots": params.sigprofiler_make_decomposition_plots,
      "collapse_to_SBS96": params.sigprofiler_collapse_to_SBS96,
      "get_all_signature_matrices": params.sigprofiler_get_all_signature_matrices,
      "export_probabilities": params.sigprofiler_export_probabilities,
    ]}
  }
}

process {
  withName: 'SPARSE_SIGNATURES' {
    time='75h'
    memory='200 GB'
    container = 'https://depot.galaxyproject.org/singularity/bioconductor-sparsesignatures%3A2.8.0--r42hdfd78af_0'
    
    ext.args   = {[
      "K": params.sparsesignatures_K,
      "background_signature": params.sparsesignatures_background_signature,
      "beta": params.sparsesignatures_beta,
      "normalize_counts": params.sparsesignatures_normalize_counts
      "nmf_runs": params.sparsesignatures_nmf_runs,
      "iterations": params.sparsesignatures_iterations,
      "max_iterations_lasso": params.sparsesignatures_max_iterations_lasso,
      "num_processes": params.sparsesignatures_num_processes,
      "starting_beta": params.sparsesignatures_starting_beta,
      "cross_validation_entries": params.sparsesignatures_cross_validation_entries,
      "cross_validation_repetitions": params.sparsesignatures_cross_validation_repetitions,
      "cross_validation_iterations": params.sparsesignatures_cross_validation_iterations,
      "lambda_rate_alpha": params.sparsesignatures_lambda_rate_alpha,
      "lambda_rate_beta": params.sparsesignatures_lambda_rate_beta,
      "seed": params.sparsesignatures_seed,
      "verbose": params.sparsesignatures_verbose,
      "log_file": params.sparsesignatures_log_file]}
  }
}

withName: 'GET_POSITIONS' {
    container = 'docker://lvaleriani/cnaqc:v5'
    memory = '50 GB'
    time = '1h'
    errorStrategy = 'finish'
}

withName: 'JOIN_POSITIONS' {
    container = 'docker://lvaleriani/cnaqc:v5'
    memory = '50 GB'
    time = '1h'
    errorStrategy = 'finish'
}


process {
  withName: 'CNA_PROCESSING' {
    container = 'docker://lvaleriani/cnaqc:v5'
    memory = '50 GB'
    time = '1h'
    errorStrategy = 'finish'
  }

  withName: 'JOIN_CNAQC' {
    container = 'docker://lvaleriani/cnaqc:v5'
    memory = '50 GB'
    time = '2h'
    errorStrategy = 'finish'
  }

  withName: 'VCF_PROCESSING' {
    container = 'docker://lvaleriani/cnaqc:v5'
    memory = '50 GB'
    time = '1h'
    errorStrategy = 'finish'
  }

  withName: 'CNAQC' {
    container = 'docker://lvaleriani/cnaqc:v5'
    memory = '100 GB'
    time = '2h'
    errorStrategy = 'finish'

    ext.args = {[
      "matching_strategy": params.cna_matching_strategy
    ]}
  }
}
